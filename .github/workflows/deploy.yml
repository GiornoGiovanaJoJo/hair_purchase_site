name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Jino VPS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy via SSH
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
      run: |
        mkdir -p ~/.ssh
        echo "$VPS_SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Create deploy script
        cat > /tmp/deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "======================================"
        echo "Deployment Started at $(date)"
        echo "======================================"
        
        echo "Step 1: Updating repository..."
        cd "$VPS_PROJECT_PATH"
        git fetch origin main
        git reset --hard origin/main
        echo "✓ Repository updated"
        
        echo "Step 2: Activating virtual environment..."
        if [ -d "venv" ]; then
          source venv/bin/activate
        else
          echo "✗ Virtual environment not found"
          exit 1
        fi
        echo "✓ Virtual environment activated"
        
        echo "Step 3: Installing dependencies..."
        pip install --upgrade pip --quiet
        pip install -r requirements.txt --quiet
        echo "✓ Dependencies installed"
        
        echo "Step 4: Running database migrations..."
        python manage.py migrate --verbosity=2 || true
        echo "✓ Migrations completed"
        
        echo "Step 5: Collecting static files..."
        python manage.py collectstatic --noinput --verbosity=1 || true
        echo "✓ Static files collected"
        
        echo "Step 6: Restarting services..."
        sudo systemctl restart gunicorn 2>/dev/null || echo "⚠ Gunicorn restart"
        sleep 2
        sudo systemctl restart nginx 2>/dev/null || echo "⚠ Nginx restart"
        echo "✓ Services restarted"
        
        echo "Step 7: Verifying services..."
        sleep 2
        if sudo systemctl is-active --quiet gunicorn 2>/dev/null; then
          echo "✓ Gunicorn is running"
        fi
        
        if sudo systemctl is-active --quiet nginx 2>/dev/null; then
          echo "✓ Nginx is running"
        fi
        
        echo ""
        echo "======================================"
        echo "Deployment completed successfully!"
        echo "======================================"
        EOF
        
        chmod +x /tmp/deploy.sh
        
        # Execute on VPS
        ssh -i ~/.ssh/deploy_key $VPS_USER@$VPS_HOST << 'REMOTE_EXEC'
        export VPS_PROJECT_PATH="$1"
        bash /tmp/deploy.sh
        REMOTE_EXEC
    
    - name: Health check
      run: |
        echo "Performing health check..."
        for i in {1..3}; do
          echo "Attempt $i of 3..."
          if curl -s -o /dev/null -w "%{http_code}" https://4895c9d9450e.vps.myjino.ru/; then
            echo ""
            echo "✓ Site is responding"
            break
          fi
          sleep 2
        done
      continue-on-error: true
    
    - name: Success notification
      if: success()
      run: |
        echo ""
        echo "✅ DEPLOYMENT SUCCESSFUL!"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "Time: $(date)"
        echo ""
        echo "Site: https://4895c9d9450e.vps.myjino.ru"
        echo "Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    
    - name: Failure notification
      if: failure()
      run: |
        echo ""
        echo "❌ DEPLOYMENT FAILED"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo ""
        echo "Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        exit 1
