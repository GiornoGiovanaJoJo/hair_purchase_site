name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Jino VPS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      env:
        VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        VPS_HOST: ${{ secrets.VPS_HOST }}
      run: |
        mkdir -p ~/.ssh
        echo "$VPS_SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: Deploy
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
      run: |
        ssh -i ~/.ssh/deploy_key $VPS_USER@$VPS_HOST << 'EOF'
        set -e
        echo "Updating repository..."
        cd $VPS_PROJECT_PATH
        git fetch origin main
        git reset --hard origin/main
        
        echo "Installing dependencies..."
        source venv/bin/activate
        pip install --upgrade pip --quiet
        pip install -r requirements.txt --quiet
        
        echo "Running migrations..."
        python manage.py migrate --verbosity=1 || true
        
        echo "Collecting static files..."
        python manage.py collectstatic --noinput --quiet || true
        
        echo "Restarting services..."
        sudo systemctl restart gunicorn || true
        sleep 2
        sudo systemctl restart nginx || true
        
        echo "Deployment completed!"
        EOF
    
    - name: Health check
      run: |
        curl -s -o /dev/null -w "Status: %{http_code}\n" https://4895c9d9450e.vps.myjino.ru/ || echo "Health check completed"
      continue-on-error: true
    
    - name: Notify
      if: success()
      run: |
        echo "âœ… DEPLOYMENT SUCCESSFUL"
        echo "Repository: ${{ github.repository }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
