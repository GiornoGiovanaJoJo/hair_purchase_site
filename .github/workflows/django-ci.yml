name: Django CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: ğŸ§ª Run Tests & Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-django flake8
    
    - name: Run linting with flake8
      run: |
        echo "ğŸ” Checking code style with flake8..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics || true
        echo "âœ… Code style check completed"
      continue-on-error: true
    
    - name: Setup Django environment
      run: |
        echo "SECRET_KEY='test-secret-key-for-ci'" > .env.test
        echo "DEBUG=True" >> .env.test
        echo "âœ… Django environment configured"
    
    - name: Check for new migrations
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: 'True'
      run: |
        echo "ğŸ”„ Checking for new migrations..."
        python manage.py makemigrations --dry-run --check || echo "âš ï¸  New migrations needed"
        echo "âœ… Migration check completed"
      continue-on-error: true
    
    - name: Apply migrations
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: 'True'
      run: |
        echo "ğŸ“Š Applying database migrations..."
        python manage.py migrate --verbosity=2
        echo "âœ… Migrations applied successfully"
    
    - name: Verify database integrity
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: 'True'
      run: |
        echo "ğŸ” Verifying database integrity..."
        python manage.py migrate --check
        echo "âœ… Database integrity verified"
    
    - name: Collect static files
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: 'True'
      run: |
        echo "ğŸ“¦ Collecting static files..."
        python manage.py collectstatic --noinput --verbosity=2
        echo "âœ… Static files collected successfully"
    
    - name: Run Django checks
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: 'True'
      run: |
        echo "âœ”ï¸  Running Django system checks..."
        python manage.py check
        echo "âœ… All Django checks passed"
    
    - name: Run pytest tests
      env:
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: 'True'
      run: |
        echo "ğŸ§ª Running unit tests..."
        python manage.py test --verbosity=2 || true
        echo "âœ… Tests completed"
      continue-on-error: true

  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ” Deploy to Jino VPS via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOYHOST }}
        username: ${{ secrets.DEPLOYUSER }}
        key: ${{ secrets.DEPLOYSSHKEY }}
        port: ${{ secrets.DEPLOYPORT }}
        timeout: 120s
        command_timeout: 60m
        script: |
          #!/bin/bash
          set -e
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸš€ DEPLOYMENT PIPELINE STARTED ğŸš€     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“… Time: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ–¥ï¸  Server: $(hostname)"
          echo "ğŸ‘¤ User: $(whoami)"
          echo ""
          
          # Navigate to project directory
          cd /opt/hair_purchase_site || { echo "âŒ ERROR: Project directory not found"; exit 1; }
          echo "ğŸ“‚ Working directory: $(pwd)"
          echo ""
          
          # Configure git
          echo "ğŸ”§ Configuring git..."
          git config --global user.email "deploy@hair-purchase.ru"
          git config --global user.name "GitHub Actions Deploy"
          echo "âœ… Git configured"
          echo ""
          
          # Save current commit for potential rollback
          PREV_COMMIT=$(git rev-parse HEAD)
          echo "ğŸ“Œ Previous commit: $PREV_COMMIT"
          
          # Update code from GitHub
          echo "ğŸ”„ Fetching latest code from GitHub..."
          git fetch origin main || { echo "âŒ ERROR: Failed to fetch from GitHub"; exit 1; }
          git reset --hard origin/main || { echo "âŒ ERROR: Failed to reset repository"; exit 1; }
          git pull origin main || { echo "âŒ ERROR: Failed to pull from GitHub"; exit 1; }
          
          CURRENT_COMMIT=$(git rev-parse --short HEAD)
          echo "âœ… Code updated to commit: $CURRENT_COMMIT"
          echo ""
          
          # Activate virtualenv
          echo "ğŸ Activating Python virtual environment..."
          if [ ! -d "venv" ]; then
            echo "âš ï¸  Virtual environment not found, creating..."
            python3 -m venv venv
          fi
          source venv/bin/activate || { echo "âŒ ERROR: Failed to activate venv"; exit 1; }
          echo "âœ… Virtual environment activated"
          echo ""
          
          # Install/update dependencies
          echo "ğŸ“¦ Installing/updating dependencies..."
          pip install --upgrade pip --quiet || { echo "âŒ ERROR: Failed to upgrade pip"; exit 1; }
          pip install -r requirements.txt --quiet || { echo "âŒ ERROR: Failed to install requirements"; exit 1; }
          echo "âœ… Dependencies installed"
          echo ""
          
          # Create new migrations if needed
          echo "ğŸ”„ Checking for new migrations..."
          python manage.py makemigrations --dry-run || python manage.py makemigrations
          echo "âœ… Migrations checked"
          echo ""
          
          # Apply migrations
          echo "ğŸ“Š Applying database migrations..."
          python manage.py migrate --noinput --verbosity=1 || { echo "âŒ ERROR: Migration failed"; exit 1; }
          echo "âœ… Migrations applied successfully"
          echo ""
          
          # Collect static files
          echo "ğŸ“¦ Collecting static files..."
          python manage.py collectstatic --noinput --verbosity=1 || { echo "âŒ ERROR: Failed to collect static files"; exit 1; }
          echo "âœ… Static files collected"
          echo ""
          
          # Run Django checks
          echo "âœ”ï¸  Running Django system checks..."
          python manage.py check || { echo "âŒ ERROR: Django checks failed"; exit 1; }
          echo "âœ… Django checks passed"
          echo ""
          
          # Restart Django service
          echo "ğŸ”„ Restarting Django application service..."
          if sudo systemctl is-active --quiet hair-purchase; then
            sudo systemctl restart hair-purchase || { echo "âŒ ERROR: Failed to restart hair-purchase service"; exit 1; }
            sleep 3
            if sudo systemctl is-active --quiet hair-purchase; then
              echo "âœ… Django service restarted successfully"
            else
              echo "âŒ ERROR: Django service is not running after restart"
              echo "ğŸ“‹ Service status:"
              sudo systemctl status hair-purchase || true
              exit 1
            fi
          else
            echo "âš ï¸  WARNING: hair-purchase service not found, skipping restart"
          fi
          echo ""
          
          # Restart Telegram bot service (if exists)
          echo "ğŸ¤– Checking Telegram bot service..."
          if sudo systemctl is-active --quiet hair-purchase-bot; then
            echo "ğŸ”„ Restarting Telegram bot service..."
            sudo systemctl restart hair-purchase-bot
            sleep 2
            if sudo systemctl is-active --quiet hair-purchase-bot; then
              echo "âœ… Telegram bot restarted successfully"
            else
              echo "âš ï¸  WARNING: Telegram bot failed to restart (non-critical)"
            fi
          else
            echo "â„¹ï¸  Telegram bot service not found"
          fi
          echo ""
          
          # Final verification
          echo "ğŸ” Verifying deployment..."
          if sudo systemctl is-active --quiet hair-purchase; then
            echo "âœ… Main service is running"
          else
            echo "âŒ ERROR: Main service is not running!"
            exit 1
          fi
          echo ""
          
          # Success message
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âœ… DEPLOYMENT COMPLETED SUCCESSFULLY  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“… Deployed: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ“ Commit: $(git rev-parse --short HEAD)"
          echo "ğŸ”— Full commit: $(git rev-parse HEAD)"
          echo "ğŸ“ Branch: $(git rev-parse --abbrev-ref HEAD)"
          echo ""
          echo "ğŸŒ Application is live at:"
          echo "   https://4895c9d9450e.vps.myjino.ru"
          echo ""

  notify:
    name: ğŸ“§ Notify on Failure
    runs-on: ubuntu-latest
    if: failure()
    needs: [test, deploy]
    
    steps:
    - name: Print deployment failure message
      run: |
        echo "âŒ DEPLOYMENT FAILED"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo ""
        echo "Please check the deployment logs:"
        echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
