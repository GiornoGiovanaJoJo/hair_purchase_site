name: Hair Purchase Site - CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'
  DJANGO_SETTINGS_MODULE: config.settings

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 isort pylint
      
      - name: Run Black formatter check
        run: black --check . --line-length 120 || true
        continue-on-error: true
      
      - name: Run Flake8 linter
        run: flake8 . --max-line-length=120 --extend-ignore=E203,W503 --exclude=venv,migrations,__pycache__ || true
        continue-on-error: true
      
      - name: Check import sorting
        run: isort --check-only . || true
        continue-on-error: true

  test:
    name: Django Tests
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: test_hair_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-django pytest-cov
      
      - name: Create .env for testing
        run: |
          cat > .env << EOF
          DEBUG=True
          SECRET_KEY=test-secret-key-change-in-production
          ALLOWED_HOSTS=localhost,127.0.0.1,testserver
          DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_hair_db
          TELEGRAM_BOT_TOKEN=test_token
          TELEGRAM_ADMIN_CHAT_ID=0
          YANDEX_METRIKA_ID=
          CORS_ALLOW_ALL=True
          EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
          EOF
      
      - name: Run Django checks
        run: python manage.py check
      
      - name: Run database migrations
        run: python manage.py migrate --run-syncdb
      
      - name: Collect static files
        run: python manage.py collectstatic --noinput --clear
        continue-on-error: true
      
      - name: Run tests with coverage
        run: |
          python -m pytest --cov=. --cov-report=xml --cov-report=term-missing -v
        continue-on-error: true
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
      
      - name: Run Bandit security check
        run: bandit -r . -ll --exclude=venv,migrations,tests || true
        continue-on-error: true
      
      - name: Check for vulnerable dependencies
        run: safety check --json || true
        continue-on-error: true

  build:
    name: Build & Prepare for Deploy
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify collectstatic
        run: python manage.py collectstatic --noinput --dry-run
        env:
          SECRET_KEY: build-secret-key
        continue-on-error: true
      
      - name: Build summary
        run: |
          echo "Build Status: SUCCESS"
          echo "Python Version: ${{ env.PYTHON_VERSION }}"
          echo "Django Package Check:"
          python -m django --version

  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://4895c9d9450e.vps.myjino.ru
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure SSH
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$VPS_SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts 2>/dev/null
      
      - name: Verify SSH connection
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          ssh -i ~/.ssh/deploy_key -o ConnectTimeout=10 "$VPS_USER@$VPS_HOST" "echo 'SSH connection verified'"
      
      - name: Execute deployment
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          cat > /tmp/deploy.sh << 'DEPLOY_SCRIPT'
          #!/bin/bash
          set -e
          PROJECT_PATH="$1"
          
          echo "[DEPLOY] Starting deployment process..."
          echo "[DEPLOY] Project path: $PROJECT_PATH"
          
          # Verify project exists
          if [ ! -d "$PROJECT_PATH" ]; then
            echo "[ERROR] Project directory not found: $PROJECT_PATH"
            exit 1
          fi
          
          cd "$PROJECT_PATH"
          
          # Check if git repository
          if [ ! -d .git ]; then
            echo "[ERROR] Not a git repository"
            exit 1
          fi
          
          # Check if venv exists
          if [ ! -d venv ]; then
            echo "[ERROR] Virtual environment not found"
            exit 1
          fi
          
          echo "[DEPLOY] Step 1: Updating repository..."
          git fetch origin main
          git reset --hard origin/main
          echo "[OK] Repository updated"
          
          echo "[DEPLOY] Step 2: Activating virtual environment..."
          source venv/bin/activate
          echo "[OK] Virtual environment activated"
          
          echo "[DEPLOY] Step 3: Upgrading pip..."
          pip install --upgrade pip --quiet
          echo "[OK] Pip upgraded"
          
          echo "[DEPLOY] Step 4: Installing dependencies..."
          pip install -r requirements.txt --quiet
          echo "[OK] Dependencies installed"
          
          echo "[DEPLOY] Step 5: Running migrations..."
          python manage.py migrate --verbosity 1
          echo "[OK] Migrations completed"
          
          echo "[DEPLOY] Step 6: Collecting static files..."
          python manage.py collectstatic --noinput --clear --verbosity 1
          echo "[OK] Static files collected"
          
          echo "[DEPLOY] Step 7: Restarting services..."
          # Try systemd first
          if systemctl is-active --quiet gunicorn 2>/dev/null; then
            sudo systemctl restart gunicorn 2>/dev/null || echo "[WARN] Could not restart gunicorn via systemd"
          else
            echo "[WARN] Gunicorn systemd service not found"
          fi
          
          sleep 2
          
          if systemctl is-active --quiet nginx 2>/dev/null; then
            sudo systemctl restart nginx 2>/dev/null || echo "[WARN] Could not restart nginx via systemd"
          else
            echo "[WARN] Nginx systemd service not found"
          fi
          
          echo "[OK] Services restart initiated"
          sleep 3
          
          echo "[DEPLOY] Step 8: Verifying deployment..."
          python manage.py check
          echo "[OK] Django checks passed"
          
          echo ""
          echo "[SUCCESS] Deployment completed successfully!"
          echo "[INFO] Site: https://4895c9d9450e.vps.myjino.ru"
          DEPLOY_SCRIPT
          
          chmod +x /tmp/deploy.sh
          ssh -i ~/.ssh/deploy_key "$VPS_USER@$VPS_HOST" /tmp/deploy.sh "$VPS_PROJECT_PATH"
      
      - name: Health check
        run: |
          echo "[HEALTH] Performing site health check..."
          for i in {1..5}; do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://4895c9d9450e.vps.myjino.ru/ || echo "000")
            if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "302" ]; then
              echo "[OK] Site is responding with HTTP $RESPONSE"
              exit 0
            else
              echo "[WARN] Attempt $i: HTTP $RESPONSE"
              sleep 3
            fi
          done
          echo "[WARN] Health check incomplete - site may still be starting up"
        continue-on-error: true
      
      - name: Deployment summary
        if: success()
        run: |
          echo ""
          echo "================================"
          echo "DEPLOYMENT SUCCESSFUL"
          echo "================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
          echo ""
          echo "Site: https://4895c9d9450e.vps.myjino.ru"
          echo "Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
      
      - name: Deployment failure notification
        if: failure()
        run: |
          echo ""
          echo "================================"
          echo "DEPLOYMENT FAILED"
          echo "================================"
          echo "Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          exit 1
